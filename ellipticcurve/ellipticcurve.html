<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple ECC Encryption/Decryption</title>
</head>
<body>
    <h1>ECC Encryption/Decryption Demo</h1>
    <input type="text" id="message" placeholder="Enter message">
    <button onclick="encryptAndDecrypt()">Encrypt and Decrypt</button>
    <p>Encrypted: <span id="encrypted"></span></p>
    <p>Decrypted: <span id="decrypted"></span></p>

    <script>
        async function encryptAndDecrypt() {
            const message = document.getElementById('message').value;
            if (!message) {
                alert('Please enter a message');
                return;
            }

            try {
                // Generate ECC key pair
                const keyPair = await window.crypto.subtle.generateKey(
                    { name: "ECDH", namedCurve: "P-256" },
                    true,
                    ["deriveKey", "deriveBits"]
                );

                // Export public key
                const publicKey = await window.crypto.subtle.exportKey("raw", keyPair.publicKey);

                // Derive bits (simulating shared secret)
                const bits = await window.crypto.subtle.deriveBits(
                    { name: "ECDH", public: keyPair.publicKey },
                    keyPair.privateKey,
                    256
                );

                // Use derived bits as key for AES-GCM
                const key = await window.crypto.subtle.importKey(
                    "raw",
                    bits,
                    { name: "AES-GCM" },
                    false,
                    ["encrypt", "decrypt"]
                );

                // Encrypt
                const encodedMessage = new TextEncoder().encode(message);
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encodedMessage
                );

                // Decrypt
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encrypted
                );

                // Display results
                document.getElementById('encrypted').textContent = btoa(String.fromCharCode.apply(null, new Uint8Array(encrypted)));
                document.getElementById('decrypted').textContent = new TextDecoder().decode(decrypted);
            } catch (error) {
                console.error('Operation failed:', error);
                alert('Operation failed. See console for details.');
            }
        }
    </script>
</body>
</html>
